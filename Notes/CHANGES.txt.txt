================================================================================
                    CM3020 AI COURSEWORK - CHANGELOG
                    Bug Fixes and Improvements
================================================================================

Date: 2024-12-24
Version: 2.0 (Major Bug Fix Release)

================================================================================
CRITICAL BUG FIXES
================================================================================

1. JOINT LIMITS CORRECTED (genome.py:316-317)
   -------------------------------------------------------------------------
   Problem: URDF joint limits were backwards (upper < lower)
   Impact:  PyBullet joint behavior was erratic/undefined

   Before:
       limit_tag.setAttribute("upper", "-3.1415")
       limit_tag.setAttribute("lower", "3.1415")

   After:
       limit_tag.setAttribute("upper", "3.1415")
       limit_tag.setAttribute("lower", "-3.1415")

2. FLOATING LIMBS FIXED (genome.py:325-333)
   -------------------------------------------------------------------------
   Problem: Joint origins could be placed up to 1 unit away from parent link
   Impact:  Limbs appeared detached/floating, creatures were physically broken

   Before:
       xyz = str(self.joint_origin_xyz_1) + " " + ...

   After:
       # Position joint at end of parent link
       xyz_1 = self.link_length * 0.5 + self.joint_origin_xyz_1 * 0.1
       xyz_2 = self.joint_origin_xyz_2 * 0.1
       xyz_3 = self.joint_origin_xyz_3 * 0.1

3. MUTATION AMOUNT PARAMETER NOW USED (genome.py:130-131)
   -------------------------------------------------------------------------
   Problem: point_mutate() ignored the 'amount' parameter, used hardcoded 0.1
   Impact:  Mutation experiments were invalid; tuning had no effect

   Before:
       gene[i] += random.uniform(-0.1, 0.1)  # Hardcoded!

   After:
       gene[i] += random.uniform(-amount, amount)  # Uses parameter

4. MOTOR AMPLITUDE STANDARDIZED (creature.py:16-18, 34)
   -------------------------------------------------------------------------
   Problem: Amplitude gene existed but was never applied to motor output
   Impact:  Motor strength was inconsistent with DNA encoding

   Before:
       self.amp = control_amp  # Stored but never used
       return output           # Raw output returned

   After:
       self.amp = 1.0          # Constant for fair testing
       return output * self.amp

5. JOINT TYPE DEAD CODE REMOVED (genome.py:301-304)
   -------------------------------------------------------------------------
   Problem: Both if/else branches set joint type to "revolute"
   Impact:  Wasted code, confusing logic

   Before:
       if self.joint_type >= 0.5:
           joint_tag.setAttribute("type", "revolute")
       else:
           joint_tag.setAttribute("type", "revolute")  # Same!

   After:
       # All joints are revolute type for consistent behavior
       joint_tag.setAttribute("type", "revolute")

================================================================================
HIGH-PRIORITY FIXES
================================================================================

6. MINIMUM LINK SIZES ENFORCED (genome.py:245-249)
   -------------------------------------------------------------------------
   Problem: Links could be near-zero size, causing physics instability
   Impact:  Microscopic/invisible links, simulation crashes

   Added:
       min_length = 0.1
       min_radius = 0.05
       actual_length = max(self.link_length, min_length)
       actual_radius = max(self.link_radius, min_radius)

7. PROPER INERTIA CALCULATION (genome.py:281-293)
   -------------------------------------------------------------------------
   Problem: Inertia was hardcoded to 0.03 regardless of link size
   Impact:  Unrealistic physics, tiny links too hard to rotate

   Before:
       inertia_tag.setAttribute("ixx", "0.03")  # Hardcoded
       inertia_tag.setAttribute("iyy", "0.03")
       inertia_tag.setAttribute("izz", "0.03")

   After:
       # Calculate proper inertia for a solid cylinder
       # Ixx = Iyy = (1/12) * m * (3*r^2 + h^2)
       # Izz = (1/2) * m * r^2
       ixx = (1.0/12.0) * mass * (3 * actual_radius**2 + actual_length**2)
       iyy = ixx
       izz = (1.0/2.0) * mass * actual_radius**2

8. RECURRENCE SCALE REDUCED (genome.py:21)
   -------------------------------------------------------------------------
   Problem: link-recurrence scale of 3 created 1-4 copies per link
   Impact:  Overly complex creatures, hard to evolve functional designs

   Before:
       "link-recurrence": {"scale":3}  # 1-4 copies

   After:
       "link-recurrence": {"scale":2}  # 1-3 copies

9. SHALLOW COPY BUG FIXED (genome.py:125-163)
   -------------------------------------------------------------------------
   Problem: copy.copy() created shallow copies, mutations corrupted parents
   Impact:  Parent DNA was modified when children mutated

   Before:
       new_genome = copy.copy(genome)  # Shallow copy!

   After:
       new_genome = [gene.copy() for gene in genome]  # Deep copy

   Applied to: point_mutate(), shrink_mutate(), grow_mutate()

10. MOTOR FORCE INCREASED (simulation.py:66)
    -------------------------------------------------------------------------
    Problem: Motor force of 5N was too weak for climbing against gravity
    Impact:  Creatures couldn't generate enough torque to climb

    Before:
        force = 5

    After:
        force = 10  # Increased for better climbing ability

11. SPAWN DISTANCE CORRECTED (creature.py:153-154, 167-168)
    -------------------------------------------------------------------------
    Problem: Code referenced spawn at (-7.8, 0) but actual spawn is (5, 0, 3)
    Impact:  Proximity fitness calculation was wrong

    Before:
        return 7.8  # Wrong distance
        return max(0, 7.8 - distance)

    After:
        return 5.0  # Correct distance from (5, 0, 3) to (0, 0)
        return max(0, 5.0 - distance)

================================================================================
SUMMARY OF FILES CHANGED
================================================================================

genome.py:
  - Line 21: Reduced recurrence scale from 3 to 2
  - Lines 125-163: Fixed shallow copy in all mutation functions
  - Lines 245-249: Added minimum link size enforcement
  - Lines 281-293: Implemented proper inertia calculation
  - Lines 301-304: Removed dead joint type code
  - Lines 316-317: Fixed joint limits (swapped upper/lower)
  - Lines 325-333: Fixed joint origin to prevent floating limbs

creature.py:
  - Lines 16-18: Hardcoded motor amplitude to 1.0
  - Line 34: Motor now returns output * self.amp
  - Lines 153-154: Fixed spawn distance to 5.0
  - Lines 167-168: Fixed proximity score calculation

simulation.py:
  - Line 66: Increased motor force from 5 to 10

================================================================================
EXPECTED IMPROVEMENTS
================================================================================

After these fixes, you should observe:
1. Creatures with connected limbs (no floating parts)
2. More stable physics simulation
3. Simpler creature structures (fewer runaway link expansions)
4. Proper mutation behavior (tunable via amount parameter)
5. Accurate fitness calculations based on actual spawn position

================================================================================
VERSION 2.1 - Additional Changes
================================================================================

Date: 2024-12-24

12. SPAWN POSITION CHANGED TO GENTLER SLOPE (simulation.py, realtime_from_csv.py)
    -------------------------------------------------------------------------
    Problem: Spawn at (5, 0, 3) was on steep slope, difficult for creatures
    Impact:  Creatures couldn't climb effectively

    Before:
        p.resetBasePositionAndOrientation(cid, [5, 0, 3], ...)

    After:
        p.resetBasePositionAndOrientation(cid, [-5, 0, 3], ...)
        # Spawns on gentler slope side of mountain

13. MOTOR FORCE REVERTED TO 5 (simulation.py)
    -------------------------------------------------------------------------
    Change: Motor force kept at original value for fair testing

    Before:
        force=10

    After:
        force=5

14. FIXED FILE PATHS IN create_graphs.py (experiments/create_graphs.py)
    -------------------------------------------------------------------------
    Problem: Used absolute paths "/results/" instead of relative "../results/"
    Impact:  Graph generation would fail to find result files

    Before:
        csv_file = f"/results/pop_size_{size}.csv"

    After:
        csv_file = f"../results/pop_size_{size}.csv"

================================================================================
FINAL FILE SUMMARY
================================================================================

simulation.py:
  - Line 36: Spawn position changed to [-5, 0, 3] (gentler slope)
  - Line 66: Motor force = 5 (constant for fair testing)

creature.py:
  - Line 154: Updated comment to reflect spawn at (-5, 0, 3)

realtime_from_csv.py:
  - Line 45: Spawn position changed to [-5, 0, 3]

experiments/create_graphs.py:
  - Fixed all file paths from "/results/" to "../results/"

================================================================================
VERSION 2.2 - Creature Size and Spawn Adjustments
================================================================================

Date: 2024-12-24

15. SPAWN POSITION MOVED CLOSER TO MOUNTAIN
    -------------------------------------------------------------------------
    Problem: Creatures spawning at (-5, 0, 3) were too far from the mountain
    Impact:  Creatures had to travel further before starting to climb

    Before:
        p.resetBasePositionAndOrientation(cid, [-5, 0, 3], ...)

    After:
        p.resetBasePositionAndOrientation(cid, [-3, 0, 2], ...)
        # Spawns closer to the mountain for better climbing interaction

    Files affected:
    - simulation.py: Line 36
    - realtime_from_csv.py: Line 45
    - creature.py: Lines 154, 168 (updated default distance from 5.0 to 3.0)

16. CREATURE SIZE REDUCED BY 1/3
    -------------------------------------------------------------------------
    Problem: Creatures were too large relative to the mountain
    Impact:  Large creatures had difficulty maneuvering on the mountain

    Before:
        "link-length": {"scale":2}     # Links up to 2 units long
        "link-radius": {"scale":1}     # Links up to 1 unit radius

    After:
        "link-length": {"scale":1.3}   # Links up to 1.3 units long
        "link-radius": {"scale":0.65}  # Links up to 0.65 unit radius

    File affected:
    - genome.py: Lines 19-20

================================================================================
VERSION 2.3 - Floating Limbs Fix (Root Cause)
================================================================================

Date: 2024-12-24

17. JOINT ORIGIN AXIS CORRECTED (genome.py:346-355)
    -------------------------------------------------------------------------
    Problem: Joint origin was offset in X-axis, but URDF cylinders extend
             along Z-axis. This placed child links BESIDE parents instead
             of at their endpoints.

    Diagnostic showed:
    - Child at (0.57, 0, 2.0) - beside parent
    - Should be at (0, 0, 2.325) - at parent's top endpoint

    Before:
        xyz_1 = self.link_length * 0.5 + self.joint_origin_xyz_1 * 0.1
        xyz_2 = self.joint_origin_xyz_2 * 0.1
        xyz_3 = self.joint_origin_xyz_3 * 0.1

    After:
        parent_len = max(self.parent_link_length, 0.1)
        xyz_1 = self.joint_origin_xyz_1 * 0.1  # Small X offset
        xyz_2 = self.joint_origin_xyz_2 * 0.1  # Small Y offset
        xyz_3 = parent_len * 0.5 + self.joint_origin_xyz_3 * 0.1  # Z = parent endpoint

18. PARENT LINK LENGTH STORED IN CHILD (genome.py:72, 226-228)
    -------------------------------------------------------------------------
    Problem: to_joint_element() had no access to parent's link_length,
             only the parent's name (string). Used child's length instead.

    Solution:
    - Added parent_link_length attribute to URDFLink class
    - Store parent's link_length in child during expandLinks()

    Added to URDFLink.__init__():
        self.parent_link_length = 0.1

    Added to expandLinks():
        c_copy.parent_link_length = parent_link.link_length

    Files affected:
    - genome.py: Lines 72, 226-228, 346-355

    Result:
    - Before: Child at X=0.57, Z=2.0 (floating beside parent)
    - After: Child at X=0.05, Z=2.325 (attached at parent's endpoint)

================================================================================
END OF CHANGELOG
================================================================================
